<!DOCTYPE html>
<html>

<head>
    <title>Reshimot</title>
    <link rel="stylesheet" href="stylesheet.css" />
</head>

<body>

    <div class="components hidden">
        <div id="base">
            <div class="cabecalho">
                <div class="ordem">
                    ?=ordem
                </div>
                <div class="menu" onclick="abrirContexto()">
                    ...
                </div>
            </div>
            <div class="foto">
                <img src="default.png" />
            </div>
            <div class="nome">
                ?=nome
            </div>
            <div class="numeros">
                <div class="numero primeiro">
                    ?=primeiro
                </div>
                <div class="numero segundo">
                    ?=segundo
                </div>
                <div class="numero terceiro">
                    ?=terceiro
                </div>
            </div>
        </div>

        <div id="popup">
            <div class="interno">

                <h2>Preencha a ficha:</h2>

                <div class="grupo">
                    <label>Nome:</label>
                    <input type="text" class="_nome" />
                </div>

                <div class="grupo">
                    <label>Iniciativa:</label>
                    <input type="text" class="_iniciativa" />
                </div>

                <div class="grupo">
                    <label>Vida:</label>
                    <input type="text" class="_vida" />
                </div>

                <div class="grupo">
                    <label>Extra:</label>
                    <input type="text" class="_extra" />
                </div>

                <div class="botoes">
                    <button onclick="confirmar()" class="confirmar">Confirmar</button>
                    <button onclick="removerFormulario()" class="cancelar">Cancelar</button>
                </div>
            </div>

        </div>
    </div>




    <div class="container">
        <div id="fichas">
            <div id="add" onclick="add()">
                +
            </div>
        </div>
    </div>


    <script>

        // localStorage.setItem('sessao', undefined);

        var sessao;

        load();

        function create() {
            sessao = {
                ultimaFicha: 0,
                fichas: []
            }
        }

        function save() {
            localStorage.setItem('sessao', JSON.stringify(sessao));
        }

        function load() {
            let session = localStorage.getItem('sessao');
            if (session && session != "undefined") {
                sessao = JSON.parse(session);
                render();
                render();
            } else {
                create();
            }
        }

        function add() {
            abrirFormulario();
        }

        function render() {

            let fichas = document.getElementsByClassName("ficha");
            let size = fichas.length;
            let index = 0;

            for (i = size; i > 0 ; i--) {
                fichas[i - 1].remove();
            }

            sessao.fichas.sort(compare);

            for (const ficha of sessao.fichas) {
                index++;
                let novaFicha = updateFicha(ficha, index);
                document.getElementById("add").before(novaFicha);
            }
        }

        function abrirFormulario() {

            let base = document.getElementById("popup");
            let novoPopup = document.createElement("div");

            novoPopup.innerHTML = base.innerHTML;
            novoPopup.setAttribute("class", "popup");
            novoPopup.setAttribute("id", "fichaForm");

            document.body.append(novoPopup);
        }

        function removerFormulario() {
            document.getElementById("fichaForm").remove();

            sessao.novaFichaHTML = undefined;
            sessao.novaFicha = undefined;
        }

        function confirmar() {
            sessao.fichas.push(obterDados());
            sessao.ultimaFicha++;

            save();
            render();
            removerFormulario();
        }

        function updateFicha(ficha, index) {

            let base = document.getElementById("base");
            let novaFichaHTML = document.createElement("div");

            novaFichaHTML.setAttribute("id", "ficha_" + ficha.id);
            novaFichaHTML.setAttribute("class", "ficha");

            let html = base.innerHTML;

            html = html.replace("?=ordem", "#" + index);
            html = html.replace("?=nome", ficha.nome);
            html = html.replace("?=primeiro", ficha.iniciativa);
            html = html.replace("?=segundo", ficha.vida);
            html = html.replace("?=terceiro", ficha.extra);

            novaFichaHTML.innerHTML = html;
            return novaFichaHTML;
        }

        function obterDados() {

            let formulario = document.getElementById("fichaForm");

            return {
                nome: formulario.getElementsByClassName("_nome")[0].value,
                iniciativa: formulario.getElementsByClassName("_iniciativa")[0].value,
                vida: formulario.getElementsByClassName("_vida")[0].value,
                extra: formulario.getElementsByClassName("_extra")[0].value,
                id: sessao.ultimaFicha + 1
            }


        }

        function compare(a, b) {

            if (parseInt(a.iniciativa) > parseInt(b.iniciativa)) {
                return -1;
            }

            if (parseInt(a.iniciativa) < parseInt(b.iniciativa)) {
                return 1;
            }

            return 0;
        }


    </script>
</body>

</html>