<!DOCTYPE html>
<html>

<head>
    <title>Reshimot - Controle de personagens para RPG</title>
    <link rel="stylesheet" href="stylesheet.css" />
    <link rel="icon" type="image/x-icon" href="logo.png" />
</head>

<body>

    <!-- sessão de componentes -->
    <div class="components hidden">

        <canvas id="canvas"></canvas>
        <input type="file" id="uploader" />

        <!-- ficha base -->
        <div id="fichaBase">
            <div class="inner" ondblclick="abrirForm('?=id', this)">
                <div class="cabecalho">
                    <div class="ordem">
                        ?=ordem
                    </div>
                    <div class="menu" onclick="abrirContexto('?=id', this)"></div>
                </div>
                <div class="foto">
                    <img src="default.png" />
                </div>
                <div class="nome" data-id="?=id" data-campo="nome">
                    ?=nome
                </div>
                <div class="numeros">
                    <div class="grupo">
                        <label>Iniciativa:</label>
                        <input type="text" inputmode="numeric" class="numero iniciativa" data-id="?=id"
                            data-campo="iniciativa" value="?=iniciativa" onchange="edit('?=id')" />
                    </div>
                    <div class="grupo">
                        <label>Iniciativa extra:</label>
                        <input type="text" inputmode="numeric" class="numero extra" data-id="?=id" data-campo="extra"
                            value="?=extra" onchange="edit('?=id')" />
                    </div>
                    <div class="grupo">
                        <label>Vida (HP):</label>
                        <input type="text" inputmode="numeric" class="numero vida" data-id="?=id" data-campo="vida"
                            value="?=vida" onchange="edit('?=id')" />
                    </div>
                    <div class="grupo">
                        <label>Armadura (CA):</label>
                        <input type="text" inputmode="numeric" class="numero armadura" data-id="?=id"
                            data-campo="armadura" value="?=armadura" onchange="edit('?=id')" />
                    </div>
                </div>
            </div>
        </div>

        <!-- formulario base -->
        <div id="formBase">
            <div class="interno">
                <div class="esquerda">
                    <h2>Ficha de personagem</h2>
                </div>
                <div class="direita">
                    <div class="foto" data-id="?=id" data-campo="imagem" data-value="">
                        <img src="default.png" onclick="escolherImagem()" />
                    </div>
                </div>
                <div class="esquerda">
                    <div class="grupo">
                        <label>Nome:</label>
                        <input type="text" data-id="?=id" data-campo="nome" />
                    </div>
                    <div class="anotacao">
                        <label>Anotações</label>
                        <textarea data-id="?=id" data-campo="anotacao"></textarea>
                    </div>
                </div>
                <div class="direita">

                    <input type="hidden" data-id="?=id" data-campo="idFicha" />

                    <div class="grupo">
                        <label>Iniciativa:</label>
                        <input type="text" data-id="?=id" data-campo="iniciativa" />
                    </div>

                    <div class="grupo">
                        <label>Iniciativa Extra:</label>
                        <input type="text" data-id="?=id" data-campo="extra" />
                    </div>

                    <div class="grupo">
                        <label>Pontos de Vida:</label>
                        <input type="text" data-id="?=id" data-campo="vida" />
                    </div>

                    <div class="grupo">
                        <label>Pontos de Armadura:</label>
                        <input type="text" data-id="?=id" data-campo="armadura" />
                    </div>
                </div>
                <div class="botoes">
                    <button onclick="confirmar()" class="confirmar">Confirmar</button>
                    <button onclick="removerFormulario()" class="cancelar">Cancelar</button>
                </div>
            </div>
        </div>

        <div id="formImagem">
            <div class="interno">
                <h3>Escolha uma imagem:</h3>

                <div class="listaImagem">
                    ?=imagens
                </div>

                <div class="botoes">
                    <button onclick="confirmar()" class="confirmar">Confirmar</button>
                    <button onclick="removerFormulario()" class="cancelar">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- menu de contexto base -->
        <div id="contextoBase">
            <ul>
                <li>Cancelar</li>
                <li onclick="remover('?=id')">Remover</li>
            </ul>
        </div>
    </div>

    <!-- parte visivel da tela -->

    <div class="nav">
        <div class="logo" title="Reshimot"><img src="logo.png" /></div>
        <div class="acoes">
            <button onclick="exportar()" title="Exportar sessão"><img src="svg/export.svg"></button>
            <button onclick="importar()" title="Importar sessão"><img src="svg/upload.svg"></button>
            <button onclick="trocarSessao()" title="Trocar de sessão"><img src="svg/settings.svg"></button>
        </div>
    </div>

    <div class="container">
        <div id="fichas">
            <div id="add" onclick="add()">
                +
            </div>
        </div>
    </div>
</body>

<script>

    // localStorage.setItem('sessao', undefined);

    var sessao;

    load();

    // carrega do armazenamento local o objeto de sessão
    function load() {
        let session = localStorage.getItem('sessao');
        if (session && session != "undefined") {
            sessao = JSON.parse(session);
            render();
        } else {
            create();
        }
    }

    // obtem da sessão uma ficha pelo id
    function get(id) {
        for (const ficha of sessao.fichas) {
            if (ficha.id == id) {
                return ficha;
            }
        }
    }

    // cria o objeto de sessão
    function create() {
        sessao = {
            ultimaFicha: 0,
            ultimaImagem: 0,
            fichas: [],
            imagens: []
        }
    }

    // salva o objeto de sessão
    function save() {
        localStorage.setItem('sessao', JSON.stringify(sessao));
    }

    // renderiza as fichas em tela
    function render() {
        let fichas = sessao.fichas;
        let fichasHTML = document.getElementsByClassName("ficha");

        // remove todas as fichas da tela
        while (fichasHTML.length > 0) {
            fichasHTML[0].remove();
        }

        // ordena as fichas por iniciativa
        fichas.sort(compare);

        for (i = 0; i < fichas.length; i++) {
            document.getElementById("add").before(buildFicha(fichas[i], i));
        }

        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('dblclick', (event) => { prevent(event) });
        });
    }

    function add() {
        abrirFormulario();
    }

    function abrirFormulario() {

        let base = document.getElementById("formBase");
        let novoPopup = document.createElement("div");

        novoPopup.innerHTML = base.innerHTML.replaceAll("?=id", "form");
        novoPopup.setAttribute("class", "popup");
        novoPopup.setAttribute("id", "fichaForm");

        document.body.append(novoPopup);
    }

    function removerFormulario() {
        document.getElementById("fichaForm").remove();
    }

    function confirmar() {
        let ficha = obterDadosFormulario();

        if (ficha.id) {
            let fichaSessao = get(ficha.id);

            fichaSessao.nome = ficha.nome;
            fichaSessao.iniciativa = ficha.iniciativa;
            fichaSessao.vida = ficha.vida;
            fichaSessao.extra = ficha.extra;
            fichaSessao.armadura = ficha.armadura;
            fichaSessao.anotacao = ficha.anotacao;

        } else {
            sessao.ultimaFicha++;
            ficha.id = sessao.ultimaFicha;
            sessao.fichas.push(ficha);
        }

        save();
        render();
        removerFormulario();

        console.log('INSERT: inserção de ficha -> ' + JSON.stringify(ficha));
    }

    function buildFicha(ficha, index) {
        let base = document.getElementById("fichaBase");
        let novaFichaHTML = document.createElement("div");

        novaFichaHTML.setAttribute("id", "ficha_" + ficha.id);
        novaFichaHTML.setAttribute("class", "ficha");

        let html = base.innerHTML;

        html = html.replaceAll("?=ordem", "#" + (index + 1));
        html = html.replaceAll("?=id", ficha.id);
        html = html.replaceAll("?=nome", ficha.nome);
        html = html.replaceAll("?=iniciativa", ficha.iniciativa);
        html = html.replaceAll("?=vida", ficha.vida);
        html = html.replaceAll("?=extra", ficha.extra);
        html = html.replaceAll("?=armadura", ficha.armadura);
        html = html.replaceAll("?=anotacao", ficha.anotacao);

        if (ficha.vida < 1) {
            novaFichaHTML.classList.add('morte');
        }

        novaFichaHTML.innerHTML = html;
        return novaFichaHTML;
    }

    function obterDadosFormulario() {
        let ficha = {
            id: obterDados('form', 'idFicha'),
            nome: obterDados('form', 'nome'),
            iniciativa: obterDados('form', 'iniciativa'),
            extra: obterDados('form', 'extra'),
            vida: obterDados('form', 'vida'),
            armadura: obterDados('form', 'armadura'),
            anotacao: obterDados('form', 'anotacao')
        }

        return ficha;
    }

    function obterDados(id, nomeCampo) {
        let campo = document.querySelector(`[data-id="${id}"][data-campo="${nomeCampo}"]`);

        if (campo && campo.value) {
            return campo.value;
        }

        if (campo && campo.innerText) {
            return campo.innerText;
        }

        return '';
    }

    function definirDados(id, nomeCampo, valor) {
        let campo = document.querySelector(`[data-id="${id}"][data-campo="${nomeCampo}"]`);
        campo.value = valor;
    }

    function escolherImagem() {
        let base = document.getElementById("formImagem");
        let novoPopup = document.createElement("div");
        let html = base.innerHTML;
        let listaImagens = "";

        for (const imagem of sessao.imagens) {
            listaImagens += buildImagem(imagem).outerHTML;
        }

        html = html.replaceAll("?=imagens", listaImagens);
        html = html.replaceAll("?=id", "formImagem");

        novoPopup.innerHTML = html;
        novoPopup.setAttribute("class", "popup");
        novoPopup.setAttribute("id", "fichaImagem");

        document.body.append(novoPopup);
    }

    function buildImagem(imagem) {
        let imagemHTML = document.createElement("img");
        let fn = "marcarEscolhida(" + imagem.id + ")";
        imagemHTML.setAttribute("onclick", fn);
        imagemHTML.setAttribute("src", imagem.url);

        return imagemHTML;
    }

    function compare(a, b) {

        if ((a.vida < 1) != (b.vida < 1)) {
            if (a.vida < 1) {
                return 1;
            }

            return -1;
        }

        if (parseInt(a.iniciativa) > parseInt(b.iniciativa)) {
            return -1;
        }

        if (parseInt(a.iniciativa) < parseInt(b.iniciativa)) {
            return 1;
        }

        if (parseInt(a.extra) > parseInt(b.extra)) {
            return -1;
        }

        if (parseInt(a.extra) < parseInt(b.extra)) {
            return 1;
        }

        return 0;
    }

    function abrirContexto(id, me) {

        removerContexto();

        let base = document.getElementById("contextoBase");
        let contexto = document.createElement("div");

        contexto.innerHTML = base.innerHTML.replaceAll("?=id", id);

        let top = me.offsetTop + 10;
        let left = me.offsetLeft + 10;

        contexto.setAttribute("class", "contexto");
        contexto.setAttribute("style", "top: " + top + "px; left: " + left + "px");

        document.body.append(contexto);

        // console.log(obterDados(id, 'nome'));

    }

    function abrirForm(id, me) {
        abrirFormulario();

        let ficha = get(id);

        definirDados('form', 'idFicha', ficha.id);
        definirDados('form', 'nome', ficha.nome);
        definirDados('form', 'iniciativa', ficha.iniciativa);
        definirDados('form', 'extra', ficha.extra);
        definirDados('form', 'vida', ficha.vida);
        definirDados('form', 'armadura', ficha.armadura);
        definirDados('form', 'anotacao', ficha.anotacao);
    }

    function removerContexto(e) {

        if (e && e.target.className == "menu") {
            return;
        }

        let contextos = document.getElementsByClassName("contexto");

        while (contextos.length > 0) {
            contextos[0].remove();
        }
    }

    function remover(id) {
        let ficha = get(id);
        sessao.fichas.splice(sessao.fichas.indexOf(ficha), 1);

        save();
        render();

        console.log('DELETE: remoção de ficha -> ' + JSON.stringify(ficha));
    }

    function marcarEscolhida(id) {
        definirDados('form', 'imagem', id);
        let imagem = getImagem(id);
        let campo = document.querySelector('#fichaForm img');
        campo.setAttribute("src", imagem.url);

        let formImagem = document.getElementById("fichaImagem");
        formImagem.remove();
    }

    function getImagem(id) {
        for (const imagem of sessao.imagens) {
            if (imagem.id == id) {
                return imagem;
            }
        }
    }

    function exportar() {
        let nome = "backup_" + new Date().getTime();
        let json = JSON.stringify(sessao);
        let link = document.createElement('a');

        link.setAttribute('href', 'data:text/json;charset=utf-8,' + encodeURIComponent(json));
        link.setAttribute('download', nome + '.json');
        link.click();
    }

    function importar() {
        let uploader = document.getElementById("uploader");

        uploader.setAttribute("accept", "image/*");
        uploader.addEventListener("change", (event) => { processarImagem(event) });
        uploader.click();
    }

    function processarImagem(e) {
        let arquivo = e.target.files[0];
        // let uploader = document.getElementById("uploader");
        // uploader.removeEventListener("change");

        salvarImagem(arquivo);
    }

    function salvarImagem(arquivo) {
        const canvas = document.getElementById('canvas');
        const contexto = canvas.getContext('2d');
        const imageURL = URL.createObjectURL(arquivo);
        const image = new Image();

        image.onload = function () {
            const size = 64;
            let largura = image.width;
            let altura = image.height;

            // redimensiona para o tamanho final
            if (largura > altura) {
                largura = size * (largura / altura);
                altura = size;
            } else {
                altura = size * (altura / largura);
                largura = size;
            }

            // centraliza a imagem
            const x = 0 - ((largura - size) / 2);
            const y = 0 - ((altura - size) / 2);

            canvas.width = size;
            canvas.height = size;

            contexto.drawImage(image, x, y, largura, altura);
            URL.revokeObjectURL(imageURL);

            sessao.ultimaImagem++;
            let url = canvas.toDataURL("image/jpeg");
            let imagem = {
                id: sessao.ultimaImagem,
                url: url
            }

            sessao.imagens.push(imagem);
            save();
        };

        image.src = imageURL;
    }

    function isPaisagem(altura, largura) {
        if (largura > altura) {
            return true;
        }

        return false;
    }

    function edit(id) {
        let ficha = get(id);

        ficha.iniciativa = processar(id, 'iniciativa', ficha.iniciativa);
        ficha.vida = processar(id, 'vida', ficha.vida);
        ficha.extra = processar(id, 'extra', ficha.extra);
        ficha.armadura = processar(id, 'armadura', ficha.armadura);

        save();
        render();
    }

    function processar(id, campo, valor) {

        let novoValor = obterDados(id, campo);
        let retorno;

        try {
            let calculo = eval(novoValor);
            if (novoValor.startsWith('+') || novoValor.startsWith('-')) {
                retorno = parseInt(valor) + parseInt(calculo);
            } else {
                retorno = calculo;
            }

        } catch (error) {
            returno = novoValor;
        }

        if (valor != retorno) {
            let ficha = get(id);
            console.log(`UPDATE: ${campo} de '${valor}' para '${retorno}' de '${ficha.nome}'.`);
        }

        return retorno;
    }

    function fecharTudo(e) {
        if (e.key === "Escape") {
            removerContexto(e);
            removerFormulario();
        }
    }

    function prevent(e) {
        e.cancelBubble = true;
        if (e.stopPropagation) e.stopPropagation();
    };

    document.addEventListener("click", (event) => { removerContexto(event) });
    document.addEventListener("keydown", (event) => { fecharTudo(event) });
</script>

</html>